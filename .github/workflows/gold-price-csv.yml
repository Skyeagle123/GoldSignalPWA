name: Gold price CSV (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 15 * * *'   # يوميًا 18:00 بيروت (15:00 UTC)

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update CSV from Stooq (XAUUSD)
        shell: bash
        run: |
          set -euo pipefail
          OUT="XAUUSD_live.csv"
          [ -f "$OUT" ] || echo "Date,Close" > "$OUT"

          # نزّل أحدث بيانات يومية من Stooq
          curl -sS -L -A "Mozilla/5.0" "https://stooq.com/q/d/l/?s=xauusd&i=d" -o /tmp/stooq.csv

          # لو الملف فاضي، اعتبر التشغيل ناجح بدون تغييرات
          [ -s /tmp/stooq.csv ] || { echo "Stooq download empty"; exit 0; }

          # آخر سطر فعلي (تجاوز الهيدر)
          LAST=$(tail -n +2 /tmp/stooq.csv | tail -n 1 || true)
          DATE=$(echo "$LAST" | cut -d, -f1)
          CLOSE=$(echo "$LAST" | cut -d, -f5)

          # لو ما قدرنا نقرأ قيم، إخرج بنجاح بدون تعديل
          if [ -z "${DATE:-}" ] || [ -z "${CLOSE:-}" ]; then
            echo "No parsed values"; exit 0
          fi

          # أضف السطر فقط إذا تاريخ جديد
          LAST_DATE=$(tail -n 1 "$OUT" | cut -d, -f1 || echo "")
          if [ "$LAST_DATE" != "$DATE" ]; then
            echo "$DATE,$CLOSE" >> "$OUT"
          fi

      - name: Commit CSV (if changed)
        shell: bash
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add XAUUSD_live.csv
          git commit -m "Update XAUUSD_live.csv" || exit 0
          git push
